<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">

<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>test</title>
  <meta name="author" content="sivoh">
  <style type="text/css">
      body                    { font-family:Helvetica,Arial,sans-serif; font-size:.83em; background-color: #ccc; color:#fff; width:100%;}
      #header                 { padding-left: 30px; }
      #header span            { display:inline-block; width: 40px; text-align: center; }
      #drop:hover             { cursor:pointer; }
      #display                { display: block; width:800px; margin: 50px auto 0; }

  </style>
  <script type="text/javascript" src="Box2DWeb-2.1.a.3.js" charset="utf-8"></script>
  <script type="text/javascript" src="deathmatch-creature-v1.js" charset="utf-8"></script>
  <script type="text/javascript" src="deathmatch-v1.js" charset="utf-8"></script>
  <script type="text/javascript" src="deathmatch-render-v1.js" charset="utf-8"></script>
  <script language="javascript">
function init() {
     var   b2Vec2 = Box2D.Common.Math.b2Vec2
      , dyn = Box2D.Dynamics, shapes = Box2D.Collision.Shapes, joints = dyn.Joints
      , b2BodyDef = dyn.b2BodyDef
      , b2Body = dyn.b2Body
      , b2FixtureDef = dyn.b2FixtureDef
      , b2Fixture = dyn.b2Fixture
      , b2FilterData = dyn.b2FilterData
      , b2World = dyn.b2World
      , b2MassData = shapes.b2MassData
      , b2PolygonShape = shapes.b2PolygonShape
      , b2CircleShape = shapes.b2CircleShape
      , b2RevoluteJointDef = joints.b2RevoluteJointDef
      , b2DebugDraw = dyn.b2DebugDraw ;

    var DAMAGE_FACTOR = 15;

    var ITERATIONS = 30000;
    var BOTTOM = 590;
    var BULLET = { x:200, y:300, vx:0, vy:0, leftFacing:false, genome: 
[{"tak":0.091, "giv":0.945, "obl":0.000, "ext":0.052, "ang":0.864, "flx":0.008, "chd":[4,3,3,0]},
 {"tak":0.834, "giv":0.388, "obl":0.079, "ext":0.788, "ang":0.264, "flx":0.180, "chd":[0,1,3]}]
          }
    var TARGET = { x:600, y:300, vx:0, vy:0, leftFacing:true, genome : 
[{"tak":0.827, "giv":0.902, "obl":0.225, "ext":0.464, "ang":0.760, "flx":0.105, "chd":[1,0,3]}]
         }


/*
MERCE
[{"obl":0.505, "giv":0.705, "ext":0.500, "tak":1.000, "ang":0.265, "flx":0.605, "chd":[1,1,1]},
 {"obl":0.530, "giv":0.525, "ext":0.000, "tak":1.000, "ang":1.000, "flx":1.000, "chd":[2,6,2]},
 {"obl":0.995, "giv":0.000, "ext":1.000, "tak":0.990, "ang":0.500, "flx":0.040, "chd":[3,2,3]}]


CLOWN
[{"obl":0.505, "giv":0.795, "ext":0.500, "tak":1.000, "ang":0.250, "flx":0.605, "chd":[1,1,1,1]},
 {"obl":0.360, "giv":0.525, "ext":0.000, "tak":1.000, "ang":1.000, "flx":0.960, "chd":[3,6,3]}]

ROVER
[{"obl":0.505, "giv":0.820, "ext":0.500, "tak":1.000, "ang":0.250, "flx":0.605, "chd":[1,1,1,1,1,1,1]},
 {"obl":0.200, "giv":0.525, "ext":0.000, "tak":1.000, "ang":1.000, "flx":0.960, "chd":[3,6,3]}]

SYRING
[{"obl":0.505, "giv":0.950, "ext":0.500, "tak":1.000, "ang":0.250, "flx":0.605, "chd":[1,1,1]},
 {"obl":0.360, "giv":0.800, "ext":0.000, "tak":1.000, "ang":1.000, "flx":1.000, "chd":[2,6,2]},
 {"obl":1.000, "giv":0.500, "ext":1.000, "tak":0.225, "ang":0.500, "flx":0.500, "chd":[3,3,3]}]

WHIP
[{"tak":0.643, "giv":0.678, "obl":0.711, "ext":0.814, "ang":0.424, "flx":0.720, "chd":[5,3,1,3]},
 {"tak":0.376, "giv":0.948, "obl":0.909, "ext":0.523, "ang":0.450, "flx":0.011, "chd":[,3,1]},
 {"tak":0.124, "giv":0.506, "obl":0.108, "ext":0.142, "ang":0.285, "flx":0.267, "chd":[0,4,5,1]}]

SNAKE
[{"tak":0.091, "giv":0.945, "obl":0.000, "ext":0.052, "ang":0.864, "flx":0.008, "chd":[4,3,3,0]},
 {"tak":0.834, "giv":0.388, "obl":0.079, "ext":0.788, "ang":0.264, "flx":0.180, "chd":[0,1,3]}]
 */

/*
TODO:
Store all junk pieces
Evaluate damage on all junk pieces.
Reshape junk on collision exit.
Remove junk after sufficient damage.
*/

    function el(id) { return document.getElementById(id); }
    function childOf(el,clss) { if (! el || el.tagName == 'BODY') return null; return (el.getAttribute('class') === clss ? el : childOf(el.parentNode,clss)); }
    function offset(el) { if ( el.tagName === 'BODY' ) return {left:0, top:0}; var o = offset(el.offsetParent); return {left:o.left+el.offsetLeft, top:o.top+el.offsetTop}; }

    function draw() {
      var ctx = el('display').getContext('2d');
      ctx.fillStyle = '#333';
      ctx.fillRect(0,0,ctx.canvas.width,ctx.canvas.height);

      ctx.save();
      ctx.fillStyle = 'rgba(10,10,10,.3)';
      ctx.strokeStyle = 'rgb(200,200,200)';

      ctx.restore();
    }

    function initDebugDraw( ctx, world ) {
      var debugDraw = new b2DebugDraw();
      ctx.save();
      debugDraw.SetSprite(ctx);
      debugDraw.SetDrawScale( 1/deathmatch.creature.PIXELS_PER_METER );
      debugDraw.SetFillAlpha(0.3);
      debugDraw.SetLineThickness(1.0);
      debugDraw.SetFlags(b2DebugDraw.e_shapeBit | b2DebugDraw.e_jointBit);
      world.SetDebugDraw(debugDraw);
      ctx.restore();
    }


    var count = 0, joint;
    function physicsUpdate() {
      deathmatch.contest.updateMatch();

      var ctx = el('display').getContext('2d');

      ctx.fillStyle = 'rgba(52,82,122,.4)';
      ctx.fillRect(0,0,ctx.canvas.width,ctx.canvas.height);

//      deathmatch.contest.world().DrawDebugData();
      deathmatch.render.renderCanvas(ctx);

      count++

      if ( deathmatch.contest.leftCreature().junk || deathmatch.contest.rightCreature().junk ) {
        clearInterval(interval);
      }
    }

    function startMatch() {
      deathmatch.contest.startMatch( TARGET.genome, BULLET.genome );
 
//      initDebugDraw(el('display').getContext('2d'), deathmatch.contest.world() );
    }

    var interval;
    var count = 0;
    function startPhysics() {
      interval = setInterval(function(){
        count++;
        if (count > ITERATIONS) clearInterval(interval); 
        physicsUpdate(); 
      }, 1000/60);
    }

    document.onkeypress = function(e) { 
      if (e.keyCode == 32) {
        if ( interval ) {
          clearInterval(interval); 
          interval = null;
        }
        else startPhysics();
      }
    }

  startMatch();
  startPhysics();
}
  </script>
</head>
<body onload="init()">
<div id="player">
  <canvas id="display" width="800" height="500"></canvas>
</div>
</body>
</html>
